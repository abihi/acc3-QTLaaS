#cloud-config

apt_update: true
apt_upgrade: true
packages:
 - build-essential
byobu_default: system

runcmd:
 - export OS_AUTH_URL=https://uppmax.cloud.snic.se:5000/v3
 - export OS_PROJECT_ID=2344cddf33a1412b846290a9fb90b762
 - export OS_PROJECT_NAME="SNIC 2018/10-30"
 - export OS_USER_DOMAIN_NAME="snic"
 - export OS_PROJECT_DOMAIN_NAME="snic"
 - if [ -z "$OS_USER_DOMAIN_NAME" ]; then unset OS_USER_DOMAIN_NAME; fi
 - unset OS_TENANT_ID
 - unset OS_TENANT_NAME
 - export OS_USERNAME="s11856"
 - export OS_PASSWORD="acc3project"
 - export OS_REGION_NAME="UPPMAX"
 - if [ -z "$OS_REGION_NAME" ]; then unset OS_REGION_NAME; fi
 - export OS_INTERFACE=public
 - export OS_IDENTITY_API_VERSION=3

 - echo "export PATH=$PATH:/usr/games" >> /home/ubuntu/.bashrc
 - source /home/ubuntu/.bashrc
 - source /home/ubuntu/bihi-openrc.sh

 - ansibleIPhost=$(openstack server list --name acc3-ansible -c Networks -f value | awk '{ split($5, v, "=");split(v[2],x,","); print x[1], "acc3-ansible"}')
 - masterIPhost=$(openstack server list --name acc3-master -c Networks -f value | awk '{ split($5, v, "=");split(v[2],x,","); print x[1], "acc3-master"}')
 - workerIPhost=$(openstack server list --name acc3-worker -c Networks -f value | awk '{ split($5, v, "=");split(v[2],x,","); print x[1], "acc3-worker"}')
 - echo $ansibleIPhost | sudo tee -a /etc/hosts
 - echo $masterIPhost | sudo tee -a /etc/hosts
 - echo $workerIPhost | sudo tee -a /etc/hosts

 - ansibleIP=$(echo $ansibleIPhost | awk '{split($1, v, " ");print v[1]}')
 - masterIP=$(echo $masterIPhost | awk '{split($1, v, " ");print v[1]}')
 - workerIP=$(echo $workerIPhost | awk '{split($1, v, " ");print v[1]}')
 - echo ansible-node ansible_ssh_host=$ansibleIP | sudo tee -a /etc/ansible/hosts
 - echo sparkmaster  ansible_ssh_host=$masterIP  | sudo tee -a /etc/ansible/hosts
 - echo sparkworker1 ansible_ssh_host=$workerIP  | sudo tee -a /etc/ansible/hosts
 - echo [configNode] | sudo tee -a /etc/ansible/hosts
 - echo ansible-node ansible_connection=local ansible_user=ubuntu | sudo tee -a /etc/ansible/hosts
 - echo [sparkmaster] | sudo tee -a /etc/ansible/hosts
 - echo sparkmaster ansible_connection=ssh ansible_user=ubuntu | sudo tee -a /etc/ansible/hosts
 - echo [sparkworker] | sudo tee -a /etc/ansible/hosts
 - echo sparkworker1 ansible_connection=ssh ansible_user=ubuntu | sudo tee -a /etc/ansible/hosts

 - cd /home/ubuntu/QTLaaS
 - ansible-playbook -s --private-key /home/ubuntu/.ssh/id_rsa spark_deployment.yml
